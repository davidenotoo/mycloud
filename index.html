<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Cloud</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="icon" href="icon.png">
  <link rel="manifest" href="manifest.json">

  <style>
    
    body{
      background-color: #1f1f1f;
    }

    .grid-container {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }
    .grid-item {
      width: 100%;
      height: 200px;
      background-color: #f0f0f0;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
      cursor: pointer;
    }
    .grid-item img, .grid-item video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    /* Stile per il modale a schermo intero */
    .modal-dialog {
      max-width: 100%;
      max-height: 100%;
      margin: 0;
    }
    .modal-content {
      width: 100%;
      height: 100%;
      background-color: #000;
    }
    .modal-body {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100%;
    }
    .modal-body img, .modal-body video {
      max-width: 90%;
      max-height: 90%;
    }
  </style>
</head>
<body class="container mt-4">

  <!-- Sezione upload con attributo multiple -->
  <input type="file" id="fileInput" accept="image/*,video/*" class="form-control mb-3" multiple>
  <button onclick="uploadFiles()" class="btn btn-primary w-100">Carica </button>

  <!-- Galleria Media -->
  <div id="gallery" class="grid-container mt-4"></div>

  <!-- Modale per visualizzare l'immagine/video a schermo intero -->
  <div class="modal fade" id="mediaModal" tabindex="-1" aria-labelledby="mediaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-body">
          <!-- Contenuto dinamico -->
        </div>
      </div>
    </div>
  </div>

  <script>
    // Configurazione GitHub
    const GITHUB_USERNAME = "davidenotoo";
    const REPO_NAME = "cloudavide";
    const BRANCH = "master";
    const FOLDER = "troj"; // Assicurati che la cartella esista
    const GITHUB_TOKEN = "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"; // Inserisci qui il tuo token personale

    // Funzione per recuperare i file dalla cartella 'troj'
    async function fetchMedia() {
      const gallery = document.getElementById("gallery");
      gallery.innerHTML = ""; // Pulisce la galleria

      const response = await fetch(`https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/${FOLDER}?ref=${BRANCH}`);
      if (!response.ok) {
        alert("Errore nel recupero dei file dalla cartella 'troj'");
        return;
      }

      const files = await response.json();
      files.forEach(async (file) => {
        const fileResponse = await fetch(file.download_url);
        const blob = await fileResponse.blob();
        const objectURL = URL.createObjectURL(blob);
        const div = document.createElement("div");
        div.className = "grid-item";

        if (file.name.endsWith(".mp4")) {
          div.innerHTML = `<video src="${objectURL}" muted autoplay controls></video>`;
        } else if (file.name.match(/\.(jpg|jpeg|png|gif)$/i)) {
          div.innerHTML = `<img src="${objectURL}" alt="Immagine" onclick="openModal('${objectURL}')">`;
        }

        gallery.appendChild(div);
      });
    }

    // Funzione per aprire il modale in modalit√† schermo intero
    function openModal(url) {
      const modalBody = document.querySelector(".modal-body");
      const fileExtension = url.split('.').pop().toLowerCase();

      if (fileExtension === "mp4") {
        modalBody.innerHTML = `<video src="${url}" controls autoplay></video>`;
      } else {
        modalBody.innerHTML = `<img src="${url}" alt="Immagine a schermo intero">`;
      }

      const modal = new bootstrap.Modal(document.getElementById('mediaModal'));
      modal.show();
    }

    // Funzione per caricare un singolo file
    function uploadSingleFile(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = async () => {
          const base64Data = reader.result.split(",")[1];
          const commitMessage = `Aggiunto ${file.name}`;
          const filePath = `${FOLDER}/${file.name}`;

          try {
            const response = await fetch(`https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/${filePath}`, {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                "Authorization": "token " + GITHUB_TOKEN
              },
              body: JSON.stringify({
                message: commitMessage,
                content: base64Data,
                branch: BRANCH
              })
            });

            if (response.ok) {
              resolve();
            } else {
              const errorData = await response.json();
              console.error("Errore durante l'upload del file:", errorData);
              reject(new Error(`Errore durante l'upload del file ${file.name}`));
            }
          } catch (error) {
            console.error("Errore di rete:", error);
            reject(new Error(`Errore di rete durante l'upload del file ${file.name}`));
          }
        };

        reader.onerror = () => {
          reject(new Error(`Errore nella lettura del file ${file.name}`));
        };
      });
    }

    // Funzione per caricare tutti i file selezionati
    async function uploadFiles() {
      const fileInput = document.getElementById("fileInput");
      if (!fileInput.files.length) {
        return alert("Seleziona almeno un file!");
      }
      
      const files = Array.from(fileInput.files);
      // Carica i file uno per uno
      for (const file of files) {
        try {
          await uploadSingleFile(file);
        } catch (error) {
          alert(error.message);
        }
      }
      alert("File caricati con successo!");
      fetchMedia(); // Ricarica la galleria dopo il caricamento
    }

    // Carica i file iniziali dalla cartella 'troj'
    fetchMedia();
  </script>

  <!-- Inclusione di Bootstrap JS per il modale -->
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
</body>
</html>
